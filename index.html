<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShareMiiShot Ultra-Light</title>
<style>
  body{font-family:system-ui,Arial;max-width:720px;margin:20px auto;padding:10px}
  h1{font-size:1.2rem}
  .hidden{display:none}
  #preview{max-width:100%;border:1px solid #ccc;padding:6px}
  .box{border:1px dashed #999;padding:12px;border-radius:8px;margin:8px 0}
  input[type=file]{display:block;margin-top:8px}
  #qr{margin-top:12px}
  .note{font-size:0.9rem;color:#666}
</style>
</head>
<body>
<h1>ShareMiiShot Ultra-Light — Prototipo Offline</h1>

<div id="wiiuUI" class="box hidden">
  <strong>Schermata Wii U — Carica screenshot</strong>
  <p class="note">Seleziona un'immagine dalla SD o memoria.</p>
  <input id="file" type="file" accept="image/*">
  <div id="info"></div>
  <canvas id="canvas" class="hidden"></canvas>
  <img id="preview" class="hidden" alt="Anteprima">
  <p><button id="generate">Genera codice & QR</button></p>
  <div id="result" class="hidden">
    <p>Codice: <strong id="code"></strong></p>
    <div id="qr"></div>
    <p class="note">Se il QR non contiene l'immagine (troppo grande), trasferisci manualmente la foto o usa SD/PC.</p>
  </div>
</div>

<div id="otherUI" class="box hidden">
  <strong>Schermata Ricezione (telefono/PC)</strong>
  <p class="note">Scannerizza il QR mostrato dalla Wii U o inserisci il codice:</p>
  <input id="codeInput" placeholder="Inserisci codice" />
  <button id="getByCode">Mostra immagine</button>
  <div id="view" class="hidden">
    <h3>Immagine</h3>
    <img id="viewImg" style="max-width:100%">
  </div>
</div>

<div id="fallback" class="box hidden">
  <strong>Modalità fallback</strong>
  <p class="note">Se l'immagine è troppo grande per il QR, condividi con SD o foto dello schermo. Per avere link e hosting, serve un server o un servizio cloud.</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
(function(){
  const ua = navigator.userAgent || '';
  const isWiiU = /Nintendo WiiU/i.test(ua);
  document.getElementById(isWiiU ? 'wiiuUI' : 'otherUI').classList.remove('hidden');
  document.getElementById('fallback').classList.remove('hidden');

  const fileInput = document.getElementById('file');
  const preview = document.getElementById('preview');
  const canvas = document.getElementById('canvas');
  const info = document.getElementById('info');
  const generateBtn = document.getElementById('generate');
  const result = document.getElementById('result');
  const codeEl = document.getElementById('code');
  const qrDiv = document.getElementById('qr');

  let lastDataURL = null;
  let lastCode = null;

  function randomCode(len=6){
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let s=''; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  fileInput && fileInput.addEventListener('change', async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    info.textContent = `File: ${f.name} — ${Math.round(f.size/1024)} KB`;
    const reader = new FileReader();
    reader.onload = function(ev){
      const img = new Image();
      img.onload = function(){
        // ridimensionamento a 620p max
        const maxDim = 620;
        let w = img.width;
        let h = img.height;
        if(w > h && w > maxDim){ h = h * maxDim / w; w = maxDim; }
        else if(h > w && h > maxDim){ w = w * maxDim / h; h = maxDim; }
        else if(w > maxDim){ w = maxDim; h = h * maxDim / w; }

        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        // compressione JPEG estrema
        lastDataURL = canvas.toDataURL('image/jpeg',0.25);
        preview.src = lastDataURL;
        preview.classList.remove('hidden');
      }
      img.src = ev.target.result;
    }
    reader.readAsDataURL(f);
  });

  generateBtn && generateBtn.addEventListener('click', () => {
    if(!lastDataURL){ alert('Seleziona prima un\'immagine'); return; }
    lastCode = randomCode(6);
    codeEl.textContent = lastCode;
    qrDiv.innerHTML = '';
    // QR con dataURL
    try {
      new QRCode(qrDiv, { text: lastDataURL, width: 200, height: 200 });
      localStorage.setItem('smi_'+lastCode, lastDataURL);
      info.innerHTML += `<br><small class="note">QR generato, immagine compressa a ~620p e alta compressione (~25%).</small>`;
    } catch(e){
      new QRCode(qrDiv, { text: `SHAREMIICODE:${lastCode}`, width: 200, height: 200 });
      info.innerHTML += `<br><small class="note">Immagine troppo grande per QR, solo codice generato.</small>`;
      localStorage.setItem('smi_'+lastCode,lastDataURL);
    }
    result.classList.remove('hidden');
  });

  document.getElementById('getByCode').addEventListener('click', () => {
    const code = document.getElementById('codeInput').value.trim();
    if(!code){ alert('Inserisci il codice'); return; }
    const data = localStorage.getItem('smi_'+code);
    if(data){
      document.getElementById('viewImg').src = data;
      document.getElementById('view').classList.remove('hidden');
    } else {
      alert('Immagine non trovata in questo browser. Se il QR conteneva il dataURL, scannerizzalo dalla Wii U.');
    }
  });
})();
</script>
</body>
</html>