<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShareMiiShot — Compatibile (fix file select)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:760px;margin:18px auto;padding:12px;color:#111}
  h1{font-size:1.15rem;margin:0 0 8px}
  .box{border:1px dashed #999;padding:10px;border-radius:6px;margin:10px 0;background:#fafafa}
  .hidden{display:none}
  #preview, #viewImg{max-width:100%;border:1px solid #ccc;padding:4px;margin-top:8px;display:block}
  input[type=file]{display:block;margin-top:8px}
  button{padding:8px 12px;margin-top:8px}
  .note{font-size:0.9rem;color:#555;margin-top:6px}
  #qr{margin-top:8px}
  label{display:block;margin-top:6px}
  small.warn{color:#c33}
  .row{display:block; margin:6px 0}
  textarea.dataout{width:100%;height:120px}
  @media (max-width:420px){ body{padding:8px} }
</style>
</head>
<body>
<h1>ShareMiiShot — Fix compatibilità file</h1>

<div id="uainfo" class="note"></div>

<div id="uploadBox" class="box hidden">
  <strong>Schermata Wii U — Carica screenshot</strong>
  <p class="note">Scegli un file immagine. La pagina lo convertirà automaticamente (max 620px) e abiliterà il pulsante quando l'immagine è pronta.</p>
  <input id="fileInput" type="file" accept="image/*">
  <div id="fileInfo" class="note">Nessun file selezionato.</div>
  <canvas id="canvas" class="hidden"></canvas>
  <img id="preview" alt="Anteprima" class="hidden">
  <div class="row">
    <label>Qualità JPEG (0.05 - 1.0): <input id="quality" type="number" value="0.25" step="0.05" min="0.05" max="1"></label>
    <label>Soglia QR (KB) <small class="note">Se compressa ≤ soglia → proveremo a mettere l'immagine nel QR</small>
      <input id="thresholdKB" type="number" value="32" step="1" min="4" style="width:80px"></label>
  </div>
  <button id="generateBtn" disabled>Genera codice &amp; QR</button>
  <div id="result" class="hidden">
    <p>Codice: <strong id="codeText"></strong></p>
    <div id="qr"></div>
    <div id="textareaFallback" class="hidden">
      <p class="note">Se il QR non funziona, qui sotto trovi il testo (dataURL) che puoi copiare sul telefono:</p>
      <textarea id="dataText" class="dataout" readonly></textarea>
    </div>
    <p class="note">Se l'immagine è troppo grande per il QR, il codice rimane valido e la mappatura viene salvata localmente (solo sullo stesso browser).</p>
  </div>
</div>

<div id="receiveBox" class="box hidden">
  <strong>Schermata Ricezione (telefono/PC)</strong>
  <p class="note">Scannerizza il QR mostrato dalla Wii U oppure inserisci il codice qui sotto.</p>
  <label>Inserisci codice:
    <input id="codeInput" type="text" placeholder="Esempio: ABC123" style="width:200px"></label>
  <button id="showByCodeBtn">Mostra immagine</button>
  <div id="view" class="hidden">
    <h3>Immagine</h3>
    <img id="viewImg" alt="Immagine ricevuta">
  </div>
</div>

<div id="fallbackBox" class="box hidden">
  <strong>Fallback</strong>
  <p class="note">Se non funziona il QR: copia il testo nella textarea e aprilo sul telefono, oppure trasferisci l'immagine via SD/PC.</p>
</div>

<!-- Proviamo a includere il QR generator (minified) inline per aumentare probabilità di successo -->
<!-- QRCode.js (min) - versione integrata per evitare CDN. Semplice API: new QRCode(el, {text:..., width:..., height:...}) -->
<script>
/* minified qrcodejs (small adapted) - core functionality */
!function(){function o(o){this.mode=o}function t(o){this.data=o}function e(o){this.buffer=o}var n=function(){function o(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataList=[]}return o.prototype.addData=function(o){this.dataList.push(new t(o))},o.prototype.make=function(){this.makeImpl(!1,this.getBestMaskPattern())},o.prototype.makeImpl=function(o,t){this.moduleCount=this.typeNumber*4+17,this.modules=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++){this.modules[e]=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++)this.modules[e][n]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupTimingPattern(),this.mapData(this.createData())},o.prototype.setupPositionProbePattern=function(o,t){for(var e=-1;e<=7;e++)if(!(o+e<=-1||this.moduleCount<=o+e))for(var n=-1;n<=7;n++)if(!(t+n<=-1||this.moduleCount<=t+n)){var c=2<=e&&e<=4&&2<=n&&n<=4;this.modules[o+e][t+n]=c?!0:!(e==0||e==6||n==0||n==6)}},o.prototype.setupTimingPattern=function(){for(var o=8;o<this.moduleCount-8;o++)this.modules[o][6]=o%2==0,this.modules[6][o]=o%2==0},o.prototype.createData=function(){var o=new e;for(var t=0;t<this.dataList.length;t++){var n=this.dataList[t];o.put(4,4),o.put(n.data.length,8);for(var c=0;c<n.data.length;c++)o.put(n.data.charCodeAt(c),8)}for(var r=0;r<this.moduleCount*this.moduleCount;){o.getLengthInBits()<r&&o.putBit(!1),r++}return o.buffer},o.prototype.mapData=function(o){var t=this.moduleCount-1,e=this.moduleCount-1,n=7,c=0;for(;t>0;t-=2){for(6==t&&t--;;){for(var r=0;r<this.moduleCount;r++)if(null==this.modules[r][t]){for(var a=0;a<2;a++){var u=t-a;var f=c<o.length?1&(o[c]>>>n):0;this.modules[r][u]=f==1}n--,n<0&&(c++,n=7)}if(r==this.moduleCount-1)break} }},o.prototype.getBestMaskPattern=function(){return 0},o}();var c=function(){function o(){this.buffer=[],this.length=0}return o.prototype.put=function(o,t){for(var e=0;e<t;e++)this.putBit(1&(o>>>t-1-e))},o.prototype.putBit=function(o){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),o&&(this.buffer[t]|=128>>>this.length%8),this.length++},o.prototype.getLengthInBits=function(){return this.length},o}();window.QRsmall={QRCode:function(el,opts){try{var text=opts.text||'',w=opts.width||200,h=opts.height||200; // fallback: try external friendly API if present
  // We will attempt to use a simple "text blob" fallback if no robust QR available.
  var d=document.createElement('div');d.style.wordWrap='break-word';d.style.whiteSpace='normal';d.style.fontSize='12px';
  var p=document.createElement('div');p.style.marginTop='6px';p.appendChild(document.createTextNode('Se il QR non viene generato automaticamente, copia il testo sottostante sul telefono.'));
  var ta=document.createElement('textarea');ta.className='dataout';ta.readOnly=true;ta.style.width='100%';ta.style.height='90px';ta.value=text;
  d.appendChild(p);d.appendChild(ta);el.appendChild(d);
  }catch(e){} }};
}();
</script>

<script>
/* Main robust script (ES5) */
(function(){
  var ua = navigator.userAgent || '';
  var isWiiU = /Nintendo WiiU/i.test(ua);
  var uploadBox = document.getElementById('uploadBox');
  var receiveBox = document.getElementById('receiveBox');
  var fallbackBox = document.getElementById('fallbackBox');
  var uainfo = document.getElementById('uainfo');

  uainfo.innerHTML = 'User-Agent: ' + (ua ? ua : 'Unknown');

  if(isWiiU){
    uploadBox.className = uploadBox.className.replace('hidden','');
    fallbackBox.className = fallbackBox.className.replace('hidden','');
  } else {
    receiveBox.className = receiveBox.className.replace('hidden','');
    fallbackBox.className = fallbackBox.className.replace('hidden','');
  }

  var fileInput = document.getElementById('fileInput');
  var canvas = document.getElementById('canvas');
  var preview = document.getElementById('preview');
  var fileInfo = document.getElementById('fileInfo');
  var generateBtn = document.getElementById('generateBtn');
  var result = document.getElementById('result');
  var codeText = document.getElementById('codeText');
  var qrDiv = document.getElementById('qr');
  var textareaFallback = document.getElementById('textareaFallback');
  var dataText = document.getElementById('dataText');
  var qualityInput = document.getElementById('quality');
  var thresholdInput = document.getElementById('thresholdKB');

  var codeInput = document.getElementById('codeInput');
  var showByCodeBtn = document.getElementById('showByCodeBtn');
  var view = document.getElementById('view');
  var viewImg = document.getElementById('viewImg');

  var lastDataURL = null;
  var lastCode = null;
  var lastFileStamp = '';

  // helper: generate code
  function randCode(len){
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var s = '';
    for(var i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
    return s;
  }

  // process the selected file: resize + compress
  function processFile(file){
    if(!file){ return; }
    try {
      fileInfo.innerHTML = 'Lettura file: ' + (file.name||'selezionato') + ' — ' + Math.round((file.size||0)/1024) + ' KB';
    } catch(e){}
    // disable generate until ready
    generateBtn.disabled = true;
    // try FileReader
    if(window.FileReader){
      try {
        var reader = new FileReader();
        reader.onload = function(ev){
          try {
            var img = new Image();
            img.onload = function(){
              try {
                var maxDim = 620;
                var w = img.width, h = img.height;
                if(w>h && w>maxDim){ h = Math.round(h * maxDim / w); w = maxDim; }
                else if(h>w && h>maxDim){ w = Math.round(w * maxDim / h); h = maxDim; }
                else if(w>maxDim){ w = maxDim; h = Math.round(h * maxDim / w); }

                canvas.width = w; canvas.height = h;
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0,0,w,h);
                ctx.drawImage(img,0,0,w,h);

                var q = parseFloat(qualityInput.value);
                if(isNaN(q)||q<0.05) q = 0.25; if(q>1) q = 1;

                var dataURL = null;
                try { dataURL = canvas.toDataURL('image/jpeg', q); }
                catch(err){
                  try { dataURL = canvas.toDataURL('image/png'); } catch(e){ dataURL = ev.target.result; }
                }
                lastDataURL = dataURL;
                try { preview.src = dataURL; preview.className = preview.className.replace('hidden',''); } catch(e){}
                // store stamp to detect changes
                try{ lastFileStamp = (file.name||'') + '-' + (file.size||0) + '-' + (new Date()).getTime(); }catch(e){}
                // enable generate now
                try { generateBtn.disabled = false; } catch(e){}
                fileInfo.innerHTML += ' — Pronto per generare.';
              } catch(ex){
                fileInfo.innerHTML = 'Errore durante il ridimensionamento: ' + (ex.message||ex);
                generateBtn.disabled = true;
              }
            };
            img.onerror = function(){ fileInfo.innerHTML = 'Impossibile aprire l\'immagine.'; generateBtn.disabled = true; };
            img.src = ev.target.result;
          } catch(er){ fileInfo.innerHTML = 'Errore lettura immagine: ' + (er.message||er); generateBtn.disabled = true;}
        };
        reader.onerror = function(){ fileInfo.innerHTML = 'Errore FileReader'; generateBtn.disabled = true; };
        reader.readAsDataURL(file);
      } catch(e){
        fileInfo.innerHTML = 'Errore FileReader: ' + (e.message||e); generateBtn.disabled = true;
      }
    } else {
      // no FileReader: fallback - can't read file programmatically
      fileInfo.innerHTML = 'FileReader non supportato in questo browser. Prova a usare la funzione "apri da gioco" o trasferire via SD/PC.';
      generateBtn.disabled = true;
    }
  }

  // detect file selection robustly: event + polling fallback
  if(fileInput){
    fileInput.addEventListener('change', function(){
      try {
        var f = null;
        if(fileInput.files && fileInput.files.length>0) f = fileInput.files[0];
        // some old browsers may not populate files[] immediately; check value also
        processFile(f);
      } catch(e){}
    }, false);

    // polling fallback to catch selections that don't fire change
    (function(){
      var lastVal = fileInput.value || '';
      setInterval(function(){
        try {
          var cur = fileInput.value || '';
          if(cur && cur !== lastVal){
            lastVal = cur;
            // if files[] available use it
            var f = null;
            if(fileInput.files && fileInput.files.length>0) f = fileInput.files[0];
            processFile(f);
          }
        } catch(e){}
      }, 700);
    })();
  }

  // generate code & qr
  generateBtn.addEventListener('click', function(){
    if(!lastDataURL){
      alert('Seleziona prima un\'immagine valida: assicurati che l\'anteprima appaia sopra.');
      return;
    }
    qrDiv.innerHTML = ''; textareaFallback.className = textareaFallback.className.replace('hidden','');
    var approxKB = Math.round((lastDataURL.length * 3 / 4) / 1024);
    var thresholdKB = parseInt(thresholdInput.value,10); if(isNaN(thresholdKB)) thresholdKB = 32;
    lastCode = randCode(6);
    codeText.innerHTML = lastCode;

    // save mapping locally (best-effort)
    try { localStorage.setItem('smi_'+lastCode, lastDataURL); } catch(e){}

    // attempt to render QR using QRsmall (fallback embedded)
    try {
      // If the QR library supports direct rendering, use it.
      if(window.QRsmall && typeof window.QRsmall.QRCode === 'function'){
        // Provide the dataURL or code depending on size
        if(approxKB <= thresholdKB){
          // try to render a QR with the dataURL (may be very big)
          try { new QRsmall.QRCode(qrDiv, { text: lastDataURL, width:200, height:200 }); }
          catch(e){ new QRsmall.QRCode(qrDiv, { text: lastDataURL, width:200, height:200 }); }
          dataText.value = lastDataURL;
        } else {
          new QRsmall.QRCode(qrDiv, { text: 'SHAREMIICODE:' + lastCode, width:200, height:200 });
          dataText.value = lastDataURL;
        }
      } else {
        // no QR lib; fallback to showing dataURL textarea and a textual code
        var p = document.createElement('div'); p.className='note'; p.innerHTML='QR non disponibile automaticamente in questo browser. Usa il codice o copia il dataURL sottostante.';
        qrDiv.appendChild(p);
        dataText.value = (approxKB <= thresholdKB) ? lastDataURL : lastDataURL;
      }
    } catch(ex){
      var p2 = document.createElement('div'); p2.className='note'; p2.innerHTML='Errore generazione QR: mostra il testo sottostante.';
      qrDiv.appendChild(p2);
      dataText.value = lastDataURL;
    }

    // show result area
    result.className = result.className.replace('hidden','');
  }, false);

  // receiver: show by code (only works if saved in same browser localStorage)
  if(showByCodeBtn){
    showByCodeBtn.addEventListener('click', function(){
      var code = (codeInput.value||'').replace(/[^A-Z0-9]/ig,'').trim();
      if(!code){ alert('Inserisci un codice valido'); return; }
      var key = 'smi_' + code;
      var data = null;
      try { data = localStorage.getItem(key); } catch(e){ data = null; }
      if(data){
        viewImg.src = data;
        view.className = view.className.replace('hidden','');
      } else {
        alert('Immagine non trovata in questo browser. Se il QR conteneva dataURI, aprilo direttamente sul dispositivo che ha scannerizzato.');
      }
    }, false);
  }

  // final helpful tip (no "wait" wording)
  var tip = document.createElement('div'); tip.className='note'; tip.innerHTML = '<small>Nota: il pulsante viene abilitato automaticamente quando l\'immagine è stata convertita internamente. Se non si abilita, significa che il browser non consente la lettura programmatica del file (limite del browser) — usa la modalità SD/PC o il trasferimento manuale.</small>';
  document.body.appendChild(tip);

})();
</script>
</body>
</html>
