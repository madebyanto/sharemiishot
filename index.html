<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShareMiiShot — Soluzione definitiva (puro JS)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:780px;margin:18px auto;padding:14px;color:#111}
  h1{font-size:1.15rem;margin:0 0 8px}
  .box{border:1px dashed #999;padding:12px;border-radius:6px;margin:10px 0;background:#fbfbfb}
  .hidden{display:none}
  #preview,#viewImg{max-width:100%;border:1px solid #ccc;padding:6px;margin-top:8px;display:block}
  input[type=file]{display:block;margin-top:8px}
  button{padding:8px 12px;margin-top:8px}
  .note{font-size:0.92rem;color:#444;margin-top:8px}
  #qr{margin-top:10px}
  textarea.dataout{width:100%;height:120px}
  label{display:block;margin-top:8px}
  small.warn{color:#b30}
  @media (max-width:420px){ body{padding:8px} }
</style>
</head>
<body>
<h1>ShareMiiShot — Soluzione definitiva</h1>

<div id="ua" class="note"></div>

<div id="uibox" class="box hidden">
  <strong>Schermata Wii U / Upload</strong>
  <p class="note">Scegli un'immagine. Se il browser non permette la lettura programmatica, leggi le istruzioni nel riquadro "Fallback definitivo".</p>
  <input id="fileInput" type="file" accept="image/*" />
  <div id="status" class="note">Nessun file selezionato.</div>

  <canvas id="canvas" class="hidden"></canvas>
  <img id="preview" alt="Anteprima" class="hidden">

  <label>Qualità JPEG (0.05 - 1.0): <input id="quality" type="number" value="0.25" step="0.05" min="0.05" max="1" style="width:80px"></label>
  <label>Soglia QR (KB): <input id="thresholdKB" type="number" value="32" step="1" min="4" style="width:80px"></label>

  <button id="generateBtn" disabled>Genera codice &amp; QR</button>

  <div id="result" class="hidden">
    <p>Codice: <strong id="codeText"></strong></p>
    <div id="qr"></div>
    <div id="dataDiv" class="hidden">
      <p class="note">QR non disponibile: copia il testo qui sotto e aprilo sul telefono.</p>
      <textarea id="dataOut" class="dataout" readonly></textarea>
    </div>
    <p class="note">La mappatura codice→immagine viene salvata in localStorage sullo stesso browser (se supportato).</p>
  </div>
</div>

<div id="receiveBox" class="box hidden">
  <strong>Schermata Ricezione</strong>
  <p class="note">Scannerizza il QR o inserisci il codice per vedere l'immagine (funziona solo se è stata salvata in questo browser).</p>
  <input id="codeIn" placeholder="Inserisci codice" style="width:180px"/>
  <button id="showBtn">Mostra immagine</button>
  <div id="view" class="hidden"><h3>Immagine</h3><img id="viewImg" alt="Immagine"></div>
</div>

<div id="fallbackBox" class="box hidden">
  <strong>Fallback definitivo (se il browser non permette la lettura)</strong>
  <ol>
    <li>Apri il gioco → fai uno screenshot → premi <strong>HOME</strong> → nella HOME apri il <strong>Browser Internet</strong>. Alcuni giochi mettono lo screenshot disponibile per la condivisione.</li>
    <li>Se non disponibile: copia l'immagine su <strong>PC o telefono</strong> via SD o collegando la console, poi apri la pagina su quel dispositivo.</li>
    <li>Ultima risorsa: usa la funzione di copia/incolla del dataURL mostrato dalla pagina (se appare) oppure trasferiscilo manualmente.</li>
  </ol>
  <p class="note">Queste azioni sono necessarie solo se il browser blocca completamente l'accesso al file.</p>
</div>

<script>
/*
  ShareMiiShot — "puro" ES5 JS, nessuna libreria esterna.
  Strategie di lettura file: FileReader -> createObjectURL -> fallback istruzioni.
*/

(function(){
  var ua = navigator.userAgent || '';
  var isWiiU = /Nintendo WiiU/i.test(ua);
  document.getElementById('ua').innerHTML = 'User-Agent: ' + ua;

  // mostra area corretta
  if(isWiiU){
    document.getElementById('uibox').className = document.getElementById('uibox').className.replace('hidden','');
    document.getElementById('fallbackBox').className = document.getElementById('fallbackBox').className.replace('hidden','');
  } else {
    document.getElementById('receiveBox').className = document.getElementById('receiveBox').className.replace('hidden','');
    // anche mostra upload se desideri testare da PC:
    document.getElementById('uibox').className = document.getElementById('uibox').className.replace('hidden','');
  }

  var fileInput = document.getElementById('fileInput');
  var status = document.getElementById('status');
  var canvas = document.getElementById('canvas');
  var preview = document.getElementById('preview');
  var generateBtn = document.getElementById('generateBtn');
  var result = document.getElementById('result');
  var codeText = document.getElementById('codeText');
  var qrDiv = document.getElementById('qr');
  var dataDiv = document.getElementById('dataDiv');
  var dataOut = document.getElementById('dataOut');
  var quality = document.getElementById('quality');
  var thresholdKB = document.getElementById('thresholdKB');

  var codeIn = document.getElementById('codeIn');
  var showBtn = document.getElementById('showBtn');
  var view = document.getElementById('view');
  var viewImg = document.getElementById('viewImg');

  var lastDataURL = null;
  var lastCode = null;

  // codice semplice generatore di ID
  function genCode(len){
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var s = '';
    for(var i=0;i<len;i++){ s += chars.charAt(Math.floor(Math.random()*chars.length)); }
    return s;
  }

  // Funzione che prende un dataURL immagine, la ridimensiona e crea preview+dataURL compressa
  function compressAndPreview(dataURL, desiredQuality, cb){
    // dataURL -> Image -> canvas -> toDataURL
    try {
      var img = new Image();
      img.onload = function(){
        try {
          var maxDim = 620;
          var w = img.width, h = img.height;
          if(w>h && w>maxDim){ h = Math.round(h * maxDim / w); w = maxDim; }
          else if(h>w && h>maxDim){ w = Math.round(w * maxDim / h); h = maxDim; }
          else if(w>maxDim){ w = maxDim; h = Math.round(h * maxDim / w); }

          canvas.width = w; canvas.height = h;
          var ctx = canvas.getContext('2d');
          ctx.clearRect(0,0,w,h);
          ctx.drawImage(img,0,0,w,h);

          // prova JPEG, fallback PNG
          var q = parseFloat(desiredQuality);
          if(isNaN(q) || q < 0.05) q = 0.25;
          if(q>1) q = 1;

          var out = null;
          try {
            out = canvas.toDataURL('image/jpeg', q);
          } catch(e) {
            try { out = canvas.toDataURL('image/png'); } catch(e2) { out = dataURL; }
          }
          // revokeObjectURL handled by caller if needed
          try { preview.src = out; preview.className = preview.className.replace('hidden',''); } catch(e){}
          cb(null, out);
        } catch(ex){ cb(ex); }
      };
      img.onerror = function(){ cb(new Error('Impossibile caricare immagine (img.onerror)')); };
      img.src = dataURL;
    } catch(err){
      cb(err);
    }
  }

  // Try to read the file using FileReader; on error call errCB so fallback can run
  function tryFileReader(file, okCB, errCB){
    if(!window.FileReader){ errCB(new Error('FileReader non disponibile')); return;}
    try {
      var fr = new FileReader();
      fr.onerror = function(e){ errCB(new Error('FileReader error')); };
      fr.onload = function(ev){
        try { okCB(ev.target.result); } catch(e){ errCB(e); }
      };
      fr.readAsDataURL(file);
    } catch(e){
      errCB(e);
    }
  }

  // Try createObjectURL fallback
  function tryObjectURL(file, okCB, errCB){
    try {
      var url = null;
      if(window.URL && window.URL.createObjectURL){
        url = window.URL.createObjectURL(file);
      } else if(window.webkitURL && window.webkitURL.createObjectURL){
        url = window.webkitURL.createObjectURL(file);
      }
      if(!url){ errCB(new Error('createObjectURL non disponibile')); return; }
      // load image from url, then revoke
      var img = new Image();
      img.onload = function(){
        try {
          // convert to dataURL via canvas by drawing the image then toDataURL
          var c = document.createElement('canvas');
          var maxDim = 620;
          var w = img.width, h = img.height;
          if(w>h && w>maxDim){ h = Math.round(h * maxDim / w); w = maxDim; }
          else if(h>w && h>maxDim){ w = Math.round(w * maxDim / h); h = maxDim; }
          else if(w>maxDim){ w = maxDim; h = Math.round(h * maxDim / w); }
          c.width = w; c.height = h;
          var ctx = c.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          var q = parseFloat(quality.value); if(isNaN(q)||q<0.05) q=0.25; if(q>1) q=1;
          var out = null;
          try { out = c.toDataURL('image/jpeg', q); } catch(e) { try{ out = c.toDataURL('image/png'); } catch(e2){ out = null; } }
          // revoke
          try { if(window.URL && window.URL.revokeObjectURL) window.URL.revokeObjectURL(url);
                if(window.webkitURL && window.webkitURL.revokeObjectURL) window.webkitURL.revokeObjectURL(url); } catch(e){}
          if(out) okCB(out); else errCB(new Error('Conversione objectURL->dataURL fallita'));
        } catch(ex){ try { if(window.URL && window.URL.revokeObjectURL) window.URL.revokeObjectURL(url); } catch(e){} errCB(ex); }
      };
      img.onerror = function(){ try { if(window.URL && window.URL.revokeObjectURL) window.URL.revokeObjectURL(url); } catch(e){} errCB(new Error('Impossibile caricare objectURL')); };
      img.src = url;
    } catch(e){ errCB(e); }
  }

  // central file processing that tries FileReader then createObjectURL
  function processSelectedFile(file){
    if(!file){ status.innerHTML = 'Nessun file valido.'; generateBtn.disabled = true; return; }
    status.innerHTML = 'File selezionato: ' + (file.name||'') + ' — ' + Math.round((file.size||0)/1024) + ' KB. Leggo...';
    generateBtn.disabled = true;
    lastDataURL = null;

    // 1) try FileReader
    tryFileReader(file, function(dataURL){
      // success
      compressAndPreview(dataURL, quality.value, function(err, compressed){
        if(err){ status.innerHTML = 'Errore compressione: ' + (err.message||err); generateBtn.disabled = true; return; }
        lastDataURL = compressed;
        status.innerHTML = 'Immagine pronta (FileReader).';
        generateBtn.disabled = false;
      });
    }, function(frErr){
      // FileReader failed — try objectURL
      status.innerHTML = 'FileReader fallito: ' + (frErr.message||frErr) + '. Provo createObjectURL...';
      tryObjectURL(file, function(dataURL){
        compressAndPreview(dataURL, quality.value, function(err, compressed){
          if(err){ status.innerHTML = 'Errore compressione (objectURL): ' + (err.message||err); generateBtn.disabled = true; return; }
          lastDataURL = compressed;
          status.innerHTML = 'Immagine pronta (createObjectURL).';
          generateBtn.disabled = false;
        });
      }, function(objErr){
        // both failed — definitive fallback
        status.innerHTML = 'Errore: impossibile leggere il file dal browser. (' + (objErr.message||objErr) + ')';
        generateBtn.disabled = true;
        // show clear fallback instructions (already visible in page)
      });
    });
  }

  // robust detection: change event + polling fallback for old UAs
  if(fileInput){
    fileInput.addEventListener('change', function(){
      try {
        var f = null;
        if(fileInput.files && fileInput.files.length>0) f = fileInput.files[0];
        processSelectedFile(f);
      } catch(e){}
    }, false);

    // polling fallback (per Wii U e browser che non sparano change)
    (function(){
      var lastVal = fileInput.value || '';
      setInterval(function(){
        try {
          var cur = fileInput.value || '';
          if(cur && cur !== lastVal){
            lastVal = cur;
            var f = null;
            if(fileInput.files && fileInput.files.length>0) f = fileInput.files[0];
            // in browsers che non supportano files[], f will be null — but we still attempt
            processSelectedFile(f);
          }
        } catch(e){}
      }, 700);
    })();
  }

  // Generate button click -> save to localStorage and produce QR or dataURL textarea
  generateBtn.addEventListener('click', function(){
    if(!lastDataURL){ alert('Immagine non pronta. Assicurati che l\'anteprima sia visibile.'); return; }
    qrDiv.innerHTML = '';
    dataDiv.className = dataDiv.className.replace('hidden','');
    var approxKB = Math.round((lastDataURL.length * 3 / 4) / 1024);
    var t = parseInt(thresholdKB.value,10); if(isNaN(t)) t = 32;
    lastCode = genCode(6);
    codeText.innerHTML = lastCode;

    // try to store locally
    try { localStorage.setItem('smi_' + lastCode, lastDataURL); } catch(e){ /* ignore */ }

    // Try to generate a simple QR (we will fallback to showing dataURL if no QR)
    try {
      // Minimal QR: we will not attempt heavy QR encoding here for max compatibility.
      // Instead: if size <= threshold render the dataURL text (user can open it), else render the code text.
      if(approxKB <= t){
        // If data small, put a link with dataURL; many phones open it directly.
        var a = document.createElement('a'); a.href = lastDataURL; a.setAttribute('download','image.jpg');
        a.appendChild(document.createTextNode('Apri immagine direttamente (tieni premuto per salvare)'));
        qrDiv.appendChild(a);

        // show dataURL in textarea as backup
        dataOut.value = lastDataURL;
      } else {
        // big: show the code in a big textarea and message to enter it in device
        var p = document.createElement('div'); p.className = 'note';
        p.innerHTML = 'Immagine compressa ≈ ' + approxKB + ' KB, troppo grande per incapsularla. Inserisci il codice manualmente su un altro browser o copia il dataURL sottostante.';
        qrDiv.appendChild(p);
        dataOut.value = lastDataURL;
      }
    } catch(e){
      dataOut.value = lastDataURL;
    }

    result.className = result.className.replace('hidden','');
  }, false);

  // receiver
  showBtn.addEventListener('click', function(){
    var code = (codeIn.value||'').replace(/[^A-Z0-9]/ig,'').trim();
    if(!code){ alert('Inserisci codice'); return; }
    var key = 'smi_' + code;
    var data = null;
    try { data = localStorage.getItem(key); } catch(e){ data = null; }
    if(data){
      viewImg.src = data;
      view.className = view.className.replace('hidden','');
    } else {
      alert('Immagine non trovata in questo browser. Se hai scannerizzato un dataURL, aprilo direttamente sul dispositivo.');
    }
  }, false);

  // final note appended
  var note = document.createElement('div'); note.className='note';
  note.innerHTML = '<small>Se dopo tutto questo il browser ancora non legge: usa la procedura "Apri da gioco" o trasferisci l\'immagine su PC/telefono via SD. Questa pagina è fatta per massima compatibilità possibile senza server.</small>';
  document.body.appendChild(note);

})(); // end
</script>
</body>
</html>
