<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>sharemiishot — Wii U friendly</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:820px;margin:14px auto;padding:12px;color:#111;background:#fff}
  header{display:block;margin-bottom:10px}
  img#banner{width:100%;max-height:140px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
  h1{font-size:1.05rem;margin:10px 0}
  .box{border:1px dashed #bbb;padding:10px;border-radius:6px;margin:10px 0;background:#fbfbfb}
  .note{font-size:0.95rem;color:#333;margin:8px 0}
  button{padding:10px 14px;font-size:1rem;border-radius:6px;border:0;background:#0b84ff;color:#fff;cursor:pointer}
  button[disabled]{opacity:0.6;cursor:default}
  #preview{display:block;margin-top:8px;max-width:100%;border:1px solid #ccc;padding:4px;border-radius:4px}
  #qr, #codeBox, #links {margin-top:10px}
  textarea.dataout{width:100%;height:96px}
  small.warn{color:#c33}
  .hidden{display:none}
  a.btnlink{display:inline-block;padding:8px 12px;background:#2d8a2d;color:#fff;border-radius:6px;text-decoration:none;margin-top:6px}
</style>
</head>
<body>
<header>
  <!-- Put your sharemiishot.png (2000x500 suggested) in the same folder as this file -->
  <img id="banner" src="sharemiishot.png" alt="sharemiishot banner">
  <h1>sharemiishot — Condividi screenshot Wii U (modalità nativa)</h1>
</header>

<div class="box">
  <div class="note"><strong>Modalità consigliata:</strong> avvia il gioco → premi HOME per mettere in pausa → dal menu HOME apri "Browser Internet" per ottenere la screenshot disponibile. Poi clicca il pulsante qui sotto.</div>
  <div style="margin-top:8px">
    <button id="grabBtn">Prendi immagine dal sistema</button>
    <button id="stopPollBtn" style="margin-left:8px;background:#777;">Ferma ricerca</button>
  </div>
  <div id="status" class="note" style="margin-top:8px">Stato: in attesa.</div>
</div>

<div id="resultArea" class="box hidden">
  <div id="previewBox">
    <div class="note"><strong>Anteprima compressa (max 620px):</strong></div>
    <img id="preview" alt="Anteprima immagine">
  </div>

  <div id="codeBox">
    <div class="note"><strong>Codice univoco:</strong> <span id="codeText" style="font-family:monospace;font-weight:bold"></span></div>
  </div>

  <div id="qr">
    <div class="note"><strong>QR / Link:</strong></div>
    <div id="qrHolder"></div>
    <div id="links" style="margin-top:8px"></div>
  </div>

  <div id="dataArea" class="note hidden">
    <div>DataURL (backup):</div>
    <textarea id="dataOut" class="dataout" readonly></textarea>
  </div>
</div>

<div class="box">
  <div class="note"><strong>Ricezione su altro dispositivo:</strong> se hai generato un codice, apri questa pagina sul telefono/PC e inserisci il codice (localStorage). Se non vedi l'immagine, copia il dataURL mostrato come backup.</div>
</div>

<script>
/* sharemiishot pure ES5 single-file */
/* Minimal QR fallback: if environment supports creating a small QR canvas, we'll attempt; otherwise we provide direct download link & dataURL */
(function(){
  // util
  function el(id){ return document.getElementById(id); }
  function setStatus(t){ try{ el('status').innerHTML = 'Stato: ' + t; }catch(e){} }
  function show(elm){ elm.className = elm.className.replace(/\bhidden\b/,'').trim(); }
  function hide(elm){ if(!elm.className.match(/\bhidden\b/)) elm.className += ' hidden'; }

  // elements
  var grabBtn = el('grabBtn');
  var stopPollBtn = el('stopPollBtn');
  var status = el('status');
  var preview = el('preview');
  var resultArea = el('resultArea');
  var codeText = el('codeText');
  var qrHolder = el('qrHolder');
  var links = el('links');
  var dataArea = el('dataArea');
  var dataOut = el('dataOut');

  // settings
  var maxDim = 620;
  var jpegQuality = 0.25; // compression
  var codeLen = 6;
  var pollIntervalMs = 900;
  var pollTimeoutMs = 22000; // 22s max

  var poller = null;
  var pollStart = 0;

  // generate small code
  function genCode(len){
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var s = '';
    for(var i=0;i<len;i++){ s += chars.charAt(Math.floor(Math.random()*chars.length)); }
    return s;
  }

  // helper: look for candidate <img> elements in the document that are not the banner
  function findCandidateImage(){
    try {
      var imgs = document.getElementsByTagName('img');
      if(!imgs) return null;
      for(var i=0;i<imgs.length;i++){
        var im = imgs[i];
        // skip the banner by id
        if(im.id === 'banner') continue;
        // skip hidden or zero size images
        var w = im.naturalWidth || im.width || 0;
        var h = im.naturalHeight || im.height || 0;
        if(w <= 8 || h <= 8) continue;
        // often the system screenshot is big: pick images larger than a small threshold
        if(w >= 64 || h >= 64){
          // prefer images with "screenshot" like words in src
          var src = (im.src || '').toLowerCase();
          if(src.indexOf('screenshot') !== -1 || src.indexOf('screen') !== -1 || src.indexOf('share') !== -1 || src.indexOf('image') !== -1){
            return im;
          }
        }
      }
      // fallback: return first image not banner and not tiny
      for(var j=0;j<imgs.length;j++){
        var im2 = imgs[j];
        if(im2.id === 'banner') continue;
        var w2 = im2.naturalWidth || im2.width || 0;
        var h2 = im2.naturalHeight || im2.height || 0;
        if(w2 > 8 && h2 > 8) return im2;
      }
      return null;
    } catch(e){
      return null;
    }
  }

  // also check for elements with background-image style (rare)
  function findCandidateBgImage(){
    try {
      var all = document.getElementsByTagName('*');
      for(var i=0;i<all.length;i++){
        var s = null;
        try { s = window.getComputedStyle(all[i]).backgroundImage || ''; } catch(e){ s = all[i].style && all[i].style.backgroundImage || ''; }
        if(s && s.indexOf('url(') !== -1){
          // extract url
          var m = s.match(/url\(["']?([^"')]+)["']?\)/);
          if(m && m[1]){
            var url = m[1];
            // Avoid banner url
            if(url.indexOf('sharemiishot.png') !== -1) continue;
            return url;
          }
        }
      }
    } catch(e){}
    return null;
  }

  // draw image (src may be data:, blob:, or http) to canvas, resize and compress -> callback(err, dataURL)
  function processImageSrc(src, cb){
    try {
      var img = new Image();
      img.onload = function(){
        try {
          var w = img.naturalWidth || img.width;
          var h = img.naturalHeight || img.height;
          if(!w || !h){ cb(new Error('Immagine senza dimensione')); return; }
          var scaleW = w, scaleH = h;
          if(w > h && w > maxDim){ scaleW = maxDim; scaleH = Math.round(h * maxDim / w); }
          else if(h > w && h > maxDim){ scaleH = maxDim; scaleW = Math.round(w * maxDim / h); }
          else if(w > maxDim){ scaleW = maxDim; scaleH = Math.round(h * maxDim / w); }

          var c = document.createElement('canvas');
          c.width = scaleW; c.height = scaleH;
          var ctx = c.getContext('2d');
          ctx.drawImage(img,0,0,scaleW,scaleH);
          // try JPEG then PNG fallback
          var out = null;
          try { out = c.toDataURL('image/jpeg', jpegQuality); } catch(e){
            try { out = c.toDataURL('image/png'); } catch(e2){ out = null; }
          }
          if(!out){ cb(new Error('Conversione canvas->dataURL fallita')); return; }
          cb(null, out);
        } catch(er){
          cb(er);
        }
      };
      img.onerror = function(){ cb(new Error('Impossibile caricare immagine (img.onerror)')); };
      // Important for blobs: set crossOrigin to anonymous may be required; but for local system images it's fine
      try { img.crossOrigin = 'anonymous'; } catch(e){}
      img.src = src;
    } catch(e){ cb(e); }
  }

  // once we have a dataURL -> display preview, code, qr, links, store localStorage
  function finalizeWithDataURL(dataURL){
    try { preview.src = dataURL; show(preview); } catch(e){}
    var code = genCode(codeLen);
    codeText.innerText = code;
    // save mapping locally
    try { localStorage.setItem('smi_' + code, dataURL); } catch(e){}
    // create quick download link
    links.innerHTML = '';
    var a = document.createElement('a'); a.href = dataURL; a.className = 'btnlink'; a.appendChild(document.createTextNode('Apri / Salva immagine'));
    a.setAttribute('download','sharemiishot.jpg');
    links.appendChild(a);
    // attempt minimal QR: draw a QR by encoding small text (we won't generate full QR for large dataURI)
    qrHolder.innerHTML = '';
    try {
      // if dataURL is small-ish, try to create QR for it (but many scanners struggle)
      var approxKB = Math.round((dataURL.length * 3 / 4) / 1024);
      if(approxKB <= 48){
        // render a text area with the dataURL and a hint
        var ta = document.createElement('textarea');
        ta.className = 'dataout';
        ta.readOnly = true;
        ta.value = dataURL;
        qrHolder.appendChild(ta);
        var hint = document.createElement('div'); hint.className='note'; hint.innerHTML = 'QR non generato automaticamente: copia il testo sopra sul telefono o apri il link "Apri / Salva immagine".';
        qrHolder.appendChild(hint);
      } else {
        // big: don't embed in QR - show code and dataURL textarea
        var ta2 = document.createElement('textarea');
        ta2.className = 'dataout';
        ta2.readOnly = true;
        ta2.value = dataURL;
        qrHolder.appendChild(ta2);
        var hint2 = document.createElement('div'); hint2.className='note'; hint2.innerHTML = 'Immagine compressa ≈ ' + Math.round((dataURL.length*3/4)/1024) + ' KB — usa il link o copia il testo.';
        qrHolder.appendChild(hint2);
      }
    } catch(e){
      // fallback
      var ta3 = document.createElement('textarea'); ta3.className='dataout'; ta3.readOnly=true; ta3.value = dataURL; qrHolder.appendChild(ta3);
    }
    show(resultArea);
  }

  // main attempt: search DOM for candidate images, then process
  function attemptGrabOnce(){
    setStatus('Ricerca immagine nel DOM...');
    // 1) candidate <img>
    var img = findCandidateImage();
    if(img && img.src){
      setStatus('Trovata immagine nel DOM, la sto processando...');
      processImageSrc(img.src, function(err, out){
        if(err){
          setStatus('Errore processing: ' + (err.message||err));
        } else {
          setStatus('Immagine processata correttamente.');
          finalizeWithDataURL(out);
        }
      });
      return true;
    }
    // 2) candidate background-image
    var bg = findCandidateBgImage();
    if(bg){
      setStatus('Trovata immagine di sfondo, la sto processando...');
      processImageSrc(bg, function(err,out){
        if(err) setStatus('Errore processing background: ' + (err.message||err));
        else { setStatus('Immagine processata correttamente.'); finalizeWithDataURL(out); }
      });
      return true;
    }
    // 3) some consoles may expose an <object> tag or plugin container: scan those for embed src
    try {
      var objs = document.getElementsByTagName('object');
      for(var i=0;i<objs.length;i++){
        var o = objs[i];
        if(o.data && o.data.indexOf('screenshot') !== -1){ processImageSrc(o.data, function(err,out){ if(!err) finalizeWithDataURL(out); }); return true; }
      }
    } catch(e){}
    return false;
  }

  // start polling: repeatedly attemptGrabOnce until found or timeout
  function startPolling(){
    if(poller) return;
    pollStart = (new Date()).getTime();
    setStatus('Avvio ricerca immagine: assicurati di aver messo in pausa e aperto il Browser dal menu HOME.');
    poller = setInterval(function(){
      try {
        var found = attemptGrabOnce();
        if(found){
          clearInterval(poller); poller = null;
          setStatus('Immagine trovata e processata.');
          return;
        }
        var now = (new Date()).getTime();
        if(now - pollStart > pollTimeoutMs){
          clearInterval(poller); poller = null;
          setStatus('Timeout ricerca immagine — non trovata. Segui il fallback nella pagina (HOME → Browser → riapri pagina).');
          // show data fallback area
          show(dataArea);
        } else {
          setStatus('Ricerca in corso... (' + Math.round((now-pollStart)/1000) + 's)');
        }
      } catch(e){
        clearInterval(poller); poller = null;
        setStatus('Errore durante ricerca: ' + (e.message||e));
      }
    }, pollIntervalMs);
  }

  function stopPolling(){
    if(poller){ clearInterval(poller); poller = null; setStatus('Ricerca interrotta.'); }
    else setStatus('Nessuna ricerca attiva.');
  }

  // attach handlers
  grabBtn.addEventListener('click', function(){
    // reset UI
    hide(resultArea);
    qrHolder.innerHTML='';
    links.innerHTML='';
    dataOut.value = '';
    hide(dataArea);
    startPolling();
  }, false);

  stopPollBtn.addEventListener('click', function(){ stopPolling(); }, false);

  // also allow manual "process current DOM" (for debugging/test)
  // expose attemptGrabOnce to global for debug (optional)
  window.__sharemiishot_debug_attempt = attemptGrabOnce;

  // small safety: show note if page is opened not from Wii U
  try {
    var ua = navigator.userAgent || '';
    if(ua.toLowerCase().indexOf('nintendo') === -1){
      // show a gentle note
      var n = document.createElement('div'); n.className='note'; n.style.marginTop='8px';
      n.innerHTML = 'Nota: stai usando questo tool fuori dalla Wii U. Il flusso nativo (HOME → pausa → Browser) va eseguito sulla console per poter trovare la screenshot automaticamente.';
      document.body.insertBefore(n, document.getElementsByClassName('box')[0]);
    }
  } catch(e){}

})(); // end
</script>
</body>
</html>
