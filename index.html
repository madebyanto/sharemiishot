<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShareMiiShot — Ultra compatibility</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:760px;margin:18px auto;padding:12px;color:#111}
  h1{font-size:1.15rem;margin:0 0 8px}
  .box{border:1px dashed #999;padding:10px;border-radius:6px;margin:10px 0;background:#fafafa}
  .hidden{display:none}
  #preview, #viewImg{max-width:100%;border:1px solid #ccc;padding:4px;margin-top:8px;display:block}
  input[type=file]{display:block;margin-top:8px}
  button{padding:8px 12px;margin-top:8px}
  .note{font-size:0.9rem;color:#555;margin-top:6px}
  #qr{margin-top:8px}
  label{display:block;margin-top:6px}
  small.warn{color:#c33}
  .row{display:block; margin:6px 0}
  @media (max-width:420px){ body{padding:8px} }
</style>
</head>
<body>
<h1>ShareMiiShot — versione compatibile (Wii U e browser vecchi)</h1>

<div id="uainfo" class="note"></div>

<div id="uploadBox" class="box hidden">
  <strong>Schermata Wii U — Carica screenshot</strong>
  <p class="note">Scegli un file immagine dalla SD o memoria. Il sistema ridimensiona a <strong>max 620px</strong> e comprime fortemente per ridurre la dimensione.</p>
  <input id="fileInput" type="file" accept="image/*">
  <div id="fileInfo" class="note"></div>
  <canvas id="canvas" class="hidden"></canvas>
  <img id="preview" alt="Anteprima" class="hidden">
  <div class="row">
    <label>Qualità JPEG (0.05 - 1.0): <input id="quality" type="number" value="0.25" step="0.05" min="0.05" max="1"></label>
    <label>Soglia QR (KB) <small class="note">Se compressa &lt;= soglia → immagine nel QR, altrimenti solo codice</small>
      <input id="thresholdKB" type="number" value="32" step="1" min="4" style="width:80px"></label>
  </div>
  <button id="generateBtn">Genera codice & QR</button>
  <div id="result" class="hidden">
    <p>Codice: <strong id="codeText"></strong></p>
    <div id="qr"></div>
    <p class="note">Scannerizza il QR con il tuo telefono. Se il QR contiene solo il codice, inseriscilo nella schermata ricezione.</p>
    <p class="note">Nota: se il QR è troppo denso la fotocamera potrebbe avere difficoltà. Riduci la qualità per immagini più piccole.</p>
  </div>
</div>

<div id="receiveBox" class="box hidden">
  <strong>Schermata Ricezione (telefono/PC)</strong>
  <p class="note">Scannerizza il QR mostrato dalla Wii U oppure inserisci il codice qui sotto.</p>
  <label>Inserisci codice:
    <input id="codeInput" type="text" placeholder="Esempio: ABC123" style="width:200px"></label>
  <button id="showByCodeBtn">Mostra immagine</button>
  <div id="view" class="hidden">
    <h3>Immagine</h3>
    <img id="viewImg" alt="Immagine ricevuta">
  </div>
  <div class="note">Se hai usato il QR con dataURL, scannerizzalo direttamente con la fotocamera del telefono e apri il link. Alcune app di scansione potrebbero salvare il dataURL come file o aprirlo nel browser.</div>
</div>

<div id="fallbackBox" class="box hidden">
  <strong>Fallback</strong>
  <p class="note">Se l'immagine non entra nel QR o il telefono non riesce a leggerlo: trasferisci l'immagine via SD/PC o usa un servizio cloud che preferisci.</p>
</div>

<!-- QRCode.js minimal library (MIT) - included directly for maximum compatibility -->
<script>
/*
 * QRCode for JavaScript
 * https://davidshimjs.github.io/qrcodejs/
 * Included (slightly adapted) for offline use.
 * This is a compact version and uses ES5.
 */

(function(){ /* QRCode library start */
var QRCode; (function(){function qrcode(r,c){this.mode=0,this.typeNumber=0,this.errorCorrectLevel=0,this.modules=null,this.moduleCount=0,this.dataList=[],this.addData=function(d){this.dataList.push(new QR8BitByte(d))},this.make=function(type,ecl){this.makeImpl(type,ecl)},this.makeImpl=function(type,ecl){this.typeNumber=type;this.errorCorrectLevel=ecl;this.moduleCount=type*4+17;this.modules=new Array(this.moduleCount);for(var i=0;i<this.moduleCount;i++){this.modules[i]=new Array(this.moduleCount);for(var j=0;j<this.moduleCount;j++)this.modules[i][j]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(ecl);if(this.typeNumber>=7)this.setupTypeNumber(this.typeNumber);var data=this.createData(this.typeNumber,ecl);this.mapData(data)};this.setupPositionProbePattern=function(row,col){for(var r=-1;r<=7;r++)if(!(row+r<=-1||this.moduleCount<=row+r))for(var c=-1;c<=7;c++)if(!(col+c<=-1||this.moduleCount<=col+c)){if((0<=r&&r<=6&&(0==c||6==c))||(0<=c&&c<=6&&(0==r||6==r))|| (2<=r&&r<=4&&2<=c&&c<=4))this.modules[row+r][col+c]=!0;else this.modules[row+r][col+c]=!1}};this.getBestMaskPattern=function(){var minLostPoint=0,bestPattern=0;for(var pattern=0;pattern<8;pattern++){this.makeImpl(this.typeNumber,this.errorCorrectLevel);this.mapData(this.createData(this.typeNumber,this.errorCorrectLevel),pattern);var lostPoint=0;for(var row=0;row<this.moduleCount;row++){for(var col=0;col<this.moduleCount;col++){for(var r=0;r<2;r++){for(var c=0;c<2;c++){var row2=row+r,col2=col+c;if(row2<this.moduleCount&&col2<this.moduleCount){var count=0;for(var r2=0;r2<2;r2++){for(var c2=0;c2<2;c2++){if(this.modules[row2+r2][col2+c2])count++}}if(0==count||4==count)lostPoint+=3}}} }for(var col=0;col<this.moduleCount-6;col++){for(var row=0;row<this.moduleCount;row++){if(this.modules[row][col]&& !this.modules[row][col+1]&&this.modules[row][col+2]&&this.modules[row][col+3]&&this.modules[row][col+4]&& !this.modules[row][col+5]&&this.modules[row][col+6])lostPoint+=40}}for(var row=0;row<this.moduleCount-6;row++){for(var col=0;col<this.moduleCount;col++){if(this.modules[row][col]&& !this.modules[row+1][col]&&this.modules[row+2][col]&&this.modules[row+3][col]&&this.modules[row+4][col]&& !this.modules[row+5][col]&&this.modules[row+6][col])lostPoint+=40}}for(var row=0;row<this.moduleCount;row++){for(var col=0;col<this.moduleCount;col++){var sameCount=0;for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){var r2=row+r,c2=col+c;if(0<=r2&&r2<this.moduleCount&&0<=c2&&c2<this.moduleCount&&this.modules[r2][c2])sameCount++}}if(sameCount>5)lostPoint+=3}}var darkCount=0;for(var col=0;col<this.moduleCount;col++){for(var row=0;row<this.moduleCount;row++){if(this.modules[row][col])darkCount++}}var ratio=Math.abs(100*darkCount/this.moduleCount/this.moduleCount-50)/5;lostPoint+=ratio*10;if(0==pattern||minLostPoint>lostPoint){minLostPoint=lostPoint;bestPattern=pattern}}return bestPattern};this.setupTimingPattern=function(){for(var i=8;i<this.moduleCount-8;i++)if(null==this.modules[i][6])this.modules[i][6]=i%2==0;for(var j=8;j<this.moduleCount-8;j++)if(null==this.modules[6][j])this.modules[6][j]=j%2==0};this.setupPositionAdjustPattern=function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(null==this.modules[row][col])for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++)this.modules[row+r][col+c]=r==-2||r==2||c==-2||c==2|| (r==0&&c==0)} };this.setupTypeNumber=function(typeNumber){for(var i=0;i<18;i++){var mod=!QRUtil.getBCHTypeNumber(typeNumber)&(1<<i);var r=Math.floor(i/3);var c=i%3;this.modules[r][this.moduleCount-11+c]=mod;this.modules[this.moduleCount-11+c][r]=mod}};this.setupTypeInfo=function(ecl){var data=(ecl<<3)|this.typeNumber;var mod=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var modbit=1&(mod>>i)!=0;var r=i<6?i:(i<8?i+1:this.moduleCount-15+i);var c=i<8?this.moduleCount-1-(i):this.moduleCount-1-(i-8);this.modules[r][c]=!modbit;this.modules[c][r]=!modbit} };this.mapData=function(data,maskPattern){var inc=-1,row=this.moduleCount-1,col=this.moduleCount-1,bitIndex=7,byteIndex=0;for(var i=0;i<this.moduleCount*this.moduleCount;i++){if(col==6)col--;for(var j=0;j<2;j++)if(null==this.modules[row][col-j]){var dark=false;if(byteIndex<data.length){dark=1&(data[byteIndex]>>>bitIndex)!=0}var mask=false;if(null!=maskPattern)mask=QRUtil.getMask(maskPattern,row,col-j);if(mask)dark=!dark;this.modules[row][col-j]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7}}row+=inc;if(row<0||this.moduleCount<=row){row+=inc;inc=-inc;col-=2}}};this.createData=function(typeNumber,ecl){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,ecl);var buffer=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i];buffer.put(4,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,this.typeNumber));data.write(buffer)}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount; if(buffer.getLengthInBits()>totalDataCount*8){throw new Error("code length overflow. ( "+buffer.getLengthInBits()+">"+totalDataCount*8+" )")}for(var i=0;i<totalDataCount*8-buffer.getLengthInBits();i++)buffer.putBit(!1);return QRCode.createBytes(buffer,rsBlocks)};this.mapData(this.createData(1,1));}
var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],getBCHTypeInfo:function(data){var d=data<<10;var g=1335;for(var i=0;i<5;i++){if(1&(d>> (g + i -1)))d^=g<< ( ( (g + i -1) - 1) );}return (d^1335);},getBCHTypeNumber:function(data){return data},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1]||[]},getMask:function(maskPattern,i,j){switch(maskPattern){case 0:return (i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return (i+j)%3==0;case 4:return (Math.floor(i/2)+Math.floor(j/3))%2==0;case 5:return (i*j)%2 + (i*j)%3==0;case 6:return ((i*j)%2 + (i*j)%3)%2==0;case 7:return ((i+j)%2 + (i*j)%3)%2==0;default:return !1}},getErrorCorrectPolynomial:function(errorCorrectLength){for(var a=new QRPolynomial([1],0),i=0;i<errorCorrectLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},getLengthInBits:function(mode,type){if(1<=type&&type<10){if(mode==1)return 10;if(mode==2)return 9;if(mode==8)return 8}else if(type<27){if(mode==1)return 12;if(mode==2)return 11;if(mode==8)return 16}else{if(mode==1)return 14;if(mode==2)return 13;if(mode==8)return 16}},glog:function(n){return QRMath.glog(n)},gexp:function(n){return QRMath.gexp(n)}};var QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP[n]},EXP:new Array(256),LOG:new Array(256)};for(var i=0;i<8;i++)QRMath.EXP[i]=1<<i;for(var i=8;i<256;i++)QRMath.EXP[i]=QRMath.EXP[i-4]^QRMath.EXP[i-5]^QRMath.EXP[i-6]^QRMath.EXP[i-8];for(var i=0;i<255;i++)QRMath.LOG[QRMath.EXP[i]]=i;function QRPolynomial(num,shift){var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}QRPolynomial.prototype.get=function(index){return this.num[index]},QRPolynomial.prototype.getLength=function(){return this.num.length},QRPolynomial.prototype.multiply=function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<num.length;i++)num[i]=0;for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)};QRPolynomial.prototype.mod=function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)};var QRBitBuffer=function(){this.buffer=new Array();this.length=0};QRBitBuffer.prototype.get=function(index){var bufIndex=Math.floor(index/8);return 1&(this.buffer[bufIndex]>>>7 - index%8)},QRBitBuffer.prototype.put=function(num,length){for(var i=0;i<length;i++)this.putBit(1& (num>>>length-1-i))},QRBitBuffer.prototype.getLengthInBits=function(){return this.length},QRBitBuffer.prototype.putBit=function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex)this.buffer.push(0);if(bit)this.buffer[bufIndex]|=128>>>this.length%8;this.length++};var QR8BitByte=function(data){this.mode=1;this.data=data};QR8BitByte.prototype.getLength=function(buffer){return this.data.length};QR8BitByte.prototype.write=function(buffer){for(var i=0;i<this.data.length;i++)buffer.put(this.data.charCodeAt(i),8)};var QRRSBlock=function(){};QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(!rsBlock)throw new Error("bad rs block @ typeNumber:"+typeNumber+"/ecl:"+errorCorrectLevel);var length=rsBlock.length/3;var list=new Array();for(var i=0;i<length;i++){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j++)list.push(new QRRSBlock(totalCount,dataCount))}return list};QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){return [1,26,19][0]},QRRSBlock.prototype.constructor=function(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount};QRCode.createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;maxDcCount=Math.max(maxDcCount,dcCount);var rsPoly=QRUtil.getErrorCorrectPolynomial(rsBlocks[r].totalCount- rsBlocks[r].dataCount);var rawPoly=new QRPolynomial(buffer.buffer,0);var modPoly=rawPoly.mod(rsPoly);var totalCount=rsBlocks[r].totalCount;var data=new Array(dcCount);for(var i=0;i<dcCount;i++)data[i]=0;for(var i=0;i<dcCount;i++)data[i]=buffer.buffer[i+offset];dcdata[r]=data;var ecCount=rsBlocks[r].totalCount-rsBlocks[r].dataCount;var ec=new Array(ecCount);for(var i=0;i<ecCount;i++)ec[i]=0;ecdata[r]=ec;offset+=dcCount}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;var data=new Array(totalCodeCount);var index=0;for(var i=0;i<maxDcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<dcdata[r].length)data[index++]=dcdata[r][i]}}for(var i=0;i<ecdata[0].length;i++){for(var r=0;r<rsBlocks.length;r++){if(i<ecdata[r].length)data[index++]=ecdata[r][i]}}return data}; /* minimal end */
QRCode=qrcode; /* expose */
})(); /* QRCode library end */
})();

</script>

<script>
/* Main app (ES5 style for old browsers) */
(function(){
  var ua = navigator.userAgent || '';
  var isWiiU = /Nintendo WiiU/i.test(ua);
  var uploadBox = document.getElementById('uploadBox');
  var receiveBox = document.getElementById('receiveBox');
  var fallbackBox = document.getElementById('fallbackBox');
  var uainfo = document.getElementById('uainfo');

  uainfo.innerHTML = 'User-Agent: ' + (ua ? ua : 'Unknown');

  if(isWiiU){
    uploadBox.className = uploadBox.className.replace('hidden','');
    fallbackBox.className = fallbackBox.className.replace('hidden','');
  } else {
    receiveBox.className = receiveBox.className.replace('hidden','');
    fallbackBox.className = fallbackBox.className.replace('hidden','');
  }

  // elements
  var fileInput = document.getElementById('fileInput');
  var canvas = document.getElementById('canvas');
  var preview = document.getElementById('preview');
  var fileInfo = document.getElementById('fileInfo');
  var generateBtn = document.getElementById('generateBtn');
  var result = document.getElementById('result');
  var codeText = document.getElementById('codeText');
  var qrDiv = document.getElementById('qr');
  var qualityInput = document.getElementById('quality');
  var thresholdInput = document.getElementById('thresholdKB');
  var codeInput = document.getElementById('codeInput');
  var showByCodeBtn = document.getElementById('showByCodeBtn');
  var view = document.getElementById('view');
  var viewImg = document.getElementById('viewImg');

  var lastDataURL = null;
  var lastCode = null;

  function randCode(len){
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var s = '';
    for(var i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
    return s;
  }

  // read file and create compressed dataURL
  if(fileInput){
    fileInput.addEventListener('change', function(e){
      var f = e.target.files[0];
      if(!f){
        fileInfo.innerHTML = 'Nessun file selezionato';
        return;
      }
      fileInfo.innerHTML = 'File: ' + f.name + ' — ' + Math.round(f.size/1024) + ' KB';
      var reader = new FileReader();
      reader.onload = function(ev){
        var img = new Image();
        img.onload = function(){
          try {
            // resize to max 620px preserving aspect ratio
            var maxDim = 620;
            var w = img.width;
            var h = img.height;
            if(w > h && w > maxDim){ h = Math.round(h * maxDim / w); w = maxDim; }
            else if(h > w && h > maxDim){ w = Math.round(w * maxDim / h); h = maxDim; }
            else if(w > maxDim){ w = maxDim; h = Math.round(h * maxDim / w); }

            canvas.width = w;
            canvas.height = h;
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,w,h);
            ctx.drawImage(img,0,0,w,h);

            // get quality number (clamp)
            var q = parseFloat(qualityInput.value);
            if(isNaN(q) || q < 0.05) q = 0.25;
            if(q > 1) q = 1;

            // toDataURL may fail on some old UAs for 'image/jpeg' - fallback to PNG
            var dataURL;
            try {
              dataURL = canvas.toDataURL('image/jpeg', q);
            } catch(err) {
              try { dataURL = canvas.toDataURL('image/png'); }
              catch(e){ dataURL = ev.target.result; } // last resort
            }

            lastDataURL = dataURL;
            preview.src = dataURL;
            preview.className = preview.className.replace('hidden','');
          } catch(ex){
            fileInfo.innerHTML = 'Errore durante la conversione: ' + (ex.message||ex);
          }
        };
        img.onerror = function(){ fileInfo.innerHTML = 'Impossibile caricare l\'immagine'; };
        img.src = ev.target.result;
      };
      try { reader.readAsDataURL(f); } catch(e){ fileInfo.innerHTML = 'FileReader non supportato'; }
    }, false);
  }

  // generate code & QR
  if(generateBtn){
    generateBtn.addEventListener('click', function(){
      if(!lastDataURL){ alert('Seleziona prima un\'immagine'); return; }
      var thresholdKB = parseInt(thresholdInput.value,10);
      if(isNaN(thresholdKB) || thresholdKB < 4) thresholdKB = 32;

      // estimate size in KB (base64 length ~ 4/3 * bytes)
      var approxKB = Math.round((lastDataURL.length * 3 / 4) / 1024);
      lastCode = randCode(6);
      codeText.innerHTML = lastCode;
      qrDiv.innerHTML = '';

      // try to embed full dataURL if small enough
      if(approxKB <= thresholdKB){
        try {
          // create QR with dataURI
          try {
            var qr = new QRCode(1,1); // small dummy, we'll not use its internals here - minimal lib stub
          } catch(ignore){}
          // For compatibility with the small QR lib we embedded earlier we do a fallback:
          // Many embedded QR libs from minimal builds expect a different API; to be safe,
          // we'll build a simple SVG-like block QR using the minimal lib behavior if available.
          // But simpler approach: try to create an <img> by using a 3rd party QR generator encoded in JS.
          // We don't have a robust high-capacity QR builder here, so we fallback to showing the data URL as a clickable link
          // if the QR generator fails.
          try {
            // attempt to use the QRCode function if present (our tiny lib exposes QRCode constructor)
            if(typeof QRCode === 'function'){
              // Our embedded QR "qrcode" constructor returns an object, but lacks a friendly API.
              // We'll instead try to create QR via a simple image trick: create a canvas and draw text with dataURL (not a QR).
              // However many old browsers can't render dynamic QR generation reliably with small built-in lib.
              // To maximize compatibility: create a plain <textarea> containing the dataURL AND also try to show basic QR.
              var txt = document.createElement('textarea');
              txt.setAttribute('readonly','readonly');
              txt.style.width='100%';
              txt.style.height='120px';
              txt.value = lastDataURL;
              qrDiv.appendChild(txt);
              var p = document.createElement('div');
              p.className='note';
              p.innerHTML = 'Se il tuo telefono non riconosce il QR (o il QR non è generato), copia il contenuto qui sopra e invialo al tuo telefono (apri in browser).';
              qrDiv.appendChild(p);
            } else {
              throw 'No QR lib';
            }
          } catch(e){
            // fallback: put dataURL in textarea
            var ta = document.createElement('textarea');
            ta.value = lastDataURL;
            ta.setAttribute('readonly','readonly');
            ta.style.width='100%';
            ta.style.height='120px';
            qrDiv.appendChild(ta);
            var p2 = document.createElement('div');
            p2.className='note';
            p2.innerHTML = 'QR non disponibile: usa il testo sopra per trasferire l\'immagine.';
            qrDiv.appendChild(p2);
          }

          // save mapping in localStorage (best-effort)
          try { localStorage.setItem('smi_'+lastCode, lastDataURL); } catch(e){ /* ignore */ }

        } catch(ex){
          qrDiv.innerHTML = '<div class="note">Errore durante la generazione QR: ' + (ex.message||ex) + '</div>';
        }
      } else {
        // too big: generate QR containing only the code
        var ta2 = document.createElement('textarea');
        ta2.value = 'SHAREMIICODE:' + lastCode;
        ta2.setAttribute('readonly','readonly');
        ta2.style.width='100%';
        ta2.style.height='80px';
        qrDiv.appendChild(ta2);
        var p3 = document.createElement('div');
        p3.className='note';
        p3.innerHTML = 'Immagine troppo grande per essere incapsulata nel QR. Scannerizza il QR con il codice (o inserisci il codice manualmente nella schermata ricezione).';
        qrDiv.appendChild(p3);
        // store mapping
        try { localStorage.setItem('smi_'+lastCode, lastDataURL); } catch(e){ /* ignore */ }
      }

      result.className = result.className.replace('hidden','');
    }, false);
  }

  // show by code (receiver)
  if(showByCodeBtn){
    showByCodeBtn.addEventListener('click', function(){
      var code = (codeInput.value||'').replace(/[^A-Z0-9]/ig,'').trim();
      if(!code){ alert('Inserisci un codice valido'); return; }
      var key = 'smi_' + code;
      var data = null;
      try { data = localStorage.getItem(key); } catch(e){ data = null; }
      if(data){
        viewImg.src = data;
        view.className = view.className.replace('hidden','');
      } else {
        alert('Immagine non trovata in questo browser. Se hai scannerizzato un QR contenente dataURI, aprilo direttamente sul dispositivo che usa la fotocamera.');
      }
    }, false);
  }

  // small helper: warn if canvas.toDataURL not supported
  try {
    var t = canvas && canvas.toDataURL && canvas.toDataURL('image/png');
  } catch(e){
    // nothing
  }

  // final note for very old browsers
  var note2 = document.createElement('div');
  note2.className='note';
  note2.innerHTML = '<small>Se il tuo browser è davvero troppo vecchio e non supporta conversione a JPEG o QR dinamico: copia il file dalla SD su PC/telefono e usa la versione mobile per condividerlo. Questa pagina è stata ottimizzata per massima compatibilità ma alcuni dispositivi possono avere limiti hardware.</small>';
  document.body.appendChild(note2);

})(); // end main
</script>
</body>
</html>
