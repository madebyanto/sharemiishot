<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>sharemiishot — Puro ES5</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;max-width:820px;margin:14px auto;padding:12px;color:#111;background:#fff}
  header{display:block;margin-bottom:10px}
  #banner{width:100%;max-height:140px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
  h1{font-size:1.05rem;margin:10px 0}
  .box{border:1px dashed #bbb;padding:10px;border-radius:6px;margin:10px 0;background:#fbfbfb}
  .note{font-size:0.95rem;color:#333;margin:8px 0}
  button{padding:10px 14px;font-size:1rem;border-radius:6px;border:0;background:#0b84ff;color:#fff;cursor:pointer}
  button[disabled]{opacity:0.6;cursor:default}
  #preview{display:block;margin-top:8px;max-width:100%;border:1px solid #ccc;padding:4px;border-radius:4px}
  #qrHolder,#links{margin-top:10px}
  textarea.dataout{width:100%;height:120px}
  small.warn{color:#c33}
  .hidden{display:none}
  a.btnlink{display:inline-block;padding:8px 12px;background:#2d8a2d;color:#fff;border-radius:6px;text-decoration:none;margin-top:6px}
  #logBox{border:1px solid #ccc;padding:6px;height:140px;overflow:auto;font-family:monospace;background:#f5f5f5;border-radius:4px;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <img id="banner" src="sharemiishot.png" alt="sharemiishot banner">
  <h1>sharemiishot — Puro ES5 (Wii U friendly)</h1>
</header>

<div class="box">
  <div class="note">Procedura: avvia il gioco → fai lo screenshot → premi HOME → apri il Browser Internet. Poi clicca "Prendi immagine dal sistema".</div>
  <div>
    <button id="grabBtn">Prendi immagine dal sistema</button>
    <button id="stopBtn" style="margin-left:8px;background:#777;">Ferma ricerca</button>
  </div>
  <div id="status" class="note">Stato: in attesa.</div>
</div>

<div id="resultArea" class="box hidden">
  <div class="note"><strong>Anteprima compressa (max 620px):</strong></div>
  <img id="preview" alt="Anteprima immagine" class="hidden">
  <div class="note"><strong>Codice univoco:</strong> <span id="codeText" style="font-family:monospace;font-weight:bold"></span></div>
  <div id="qrHolder"></div>
  <div id="links"></div>
  <div id="dataArea" class="note hidden">
    <div>DataURL (backup):</div>
    <textarea id="dataOut" class="dataout" readonly></textarea>
  </div>
</div>

<div class="box">
  <div class="note">Ricezione: apri questa pagina su un altro dispositivo e inserisci il codice generato (se l'immagine è stata salvata nel browser locale tramite localStorage).</div>
</div>

<div class="box">
  <div class="note"><strong>Log diagnostico:</strong></div>
  <div id="logBox"></div>
</div>

<script>
/* sharemiishot - puro ES5, nessuna dipendenza esterna */
(function () {
  /* elementi */
  function el(id){ return document.getElementById(id); }
  var grabBtn = el('grabBtn');
  var stopBtn = el('stopBtn');
  var statusEl = el('status');
  var preview = el('preview');
  var resultArea = el('resultArea');
  var codeText = el('codeText');
  var qrHolder = el('qrHolder');
  var links = el('links');
  var dataArea = el('dataArea');
  var dataOut = el('dataOut');
  var logBox = el('logBox');

  /* impostazioni */
  var MAX_DIM = 620;
  var JPEG_QUALITY = 0.25;
  var CODE_LEN = 6;
  var POLL_INTERVAL = 900;
  var POLL_TIMEOUT = 22000;

  var poller = null;
  var pollStart = 0;

  /* utilità */
  function logMsg(msg){
    try {
      var now = new Date();
      var timestamp = now.getHours() + ':' + (now.getMinutes()<10?('0'+now.getMinutes()):now.getMinutes()) + ':' + (now.getSeconds()<10?('0'+now.getSeconds()):now.getSeconds());
      logBox.textContent += '[' + timestamp + '] ' + msg + '\n';
      logBox.scrollTop = logBox.scrollHeight;
    } catch(e){}
  }
  function setStatus(txt){
    try { statusEl.innerHTML = 'Stato: ' + txt; } catch(e){}
    logMsg(txt);
  }
  function show(node){ if(node.className.indexOf('hidden') !== -1) node.className = node.className.replace('hidden','').trim(); }
  function hide(node){ if(node.className.indexOf('hidden') === -1) node.className += ' hidden'; }
  function genCode(len){
    var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var s = '';
    for(var i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
    return s;
  }

  /* ricerca immagini: img, embed, object, video poster, background-image */
  function findCandidateImage(){
    try {
      var imgs = document.getElementsByTagName('img');
      for(var i=0;i<imgs.length;i++){
        var im = imgs[i];
        if(im.id === 'banner') continue;
        var w = im.naturalWidth || im.width || 0;
        var h = im.naturalHeight || im.height || 0;
        if(w > 16 || h > 16) {
          // prefer sources with keywords
          var src = (im.src || '').toLowerCase();
          if(src.indexOf('screenshot') !== -1 || src.indexOf('screen') !== -1 || src.indexOf('share') !== -1 || src.indexOf('image') !== -1) {
            return im.src;
          }
        }
      }
      // fallback: first non-banner non-tiny img
      for(var j=0;j<imgs.length;j++){
        var im2 = imgs[j];
        if(im2.id === 'banner') continue;
        var w2 = im2.naturalWidth || im2.width || 0;
        var h2 = im2.naturalHeight || im2.height || 0;
        if(w2 > 16 || h2 > 16) return im2.src;
      }

      // object/embed tags
      var objs = document.getElementsByTagName('object');
      for(var k=0;k<objs.length;k++){
        var o = objs[k];
        if(o.data) {
          var d = o.data.toLowerCase();
          if(d.indexOf('screenshot') !== -1 || d.indexOf('screen') !== -1) return o.data;
        }
      }
      var embs = document.getElementsByTagName('embed');
      for(var m=0;m<embs.length;m++){
        var e = embs[m];
        if(e.src) {
          var s = e.src.toLowerCase();
          if(s.indexOf('screenshot') !== -1 || s.indexOf('screen') !== -1) return e.src;
        }
      }

      // video poster attributes
      var vids = document.getElementsByTagName('video');
      for(var v=0; v<vids.length; v++){
        var vid = vids[v];
        if(vid.poster) return vid.poster;
      }

      // background-image styles
      var all = document.getElementsByTagName('*');
      for(var a=0;a<all.length;a++){
        try {
          var st = window.getComputedStyle ? window.getComputedStyle(all[a],null).backgroundImage : all[a].style.backgroundImage;
          if(st && st.indexOf('url(') !== -1) {
            var m = st.match(/url\(["']?([^"')]+)["']?\)/);
            if(m && m[1]) {
              var url = m[1];
              if(url.indexOf('sharemiishot.png') !== -1) continue;
              return url;
            }
          }
        } catch(e){}
      }

      return null;
    } catch(err){
      logMsg('findCandidateImage error: ' + (err.message || err));
      return null;
    }
  }

  /* processImage: carica src in Image, ridimensiona su canvas e restituisce dataURL compresso */
  function processImageSrc(src, cb){
    try {
      var img = new Image();
      img.onload = function(){
        try {
          var w = img.naturalWidth || img.width;
          var h = img.naturalHeight || img.height;
          if(!w || !h){ cb(new Error('Immagine senza dimensione')); return; }

          var scaleW = w, scaleH = h;
          if(w > h && w > MAX_DIM){ scaleW = MAX_DIM; scaleH = Math.round(h * MAX_DIM / w); }
          else if(h >= w && h > MAX_DIM){ scaleH = MAX_DIM; scaleW = Math.round(w * MAX_DIM / h); }
          else if(w > MAX_DIM){ scaleW = MAX_DIM; scaleH = Math.round(h * MAX_DIM / w); }

          var c = document.createElement('canvas');
          c.width = scaleW;
          c.height = scaleH;
          var ctx = c.getContext('2d');
          ctx.drawImage(img, 0, 0, scaleW, scaleH);

          var out = null;
          try { out = c.toDataURL('image/jpeg', JPEG_QUALITY); } catch(e) {
            try { out = c.toDataURL('image/png'); } catch(e2) { out = null; }
          }
          if(!out) { cb(new Error('Conversione canvas->dataURL fallita')); return; }
          cb(null, out);
        } catch(ex) { cb(ex); }
      };
      img.onerror = function(){ cb(new Error('Impossibile caricare immagine (img.onerror)')); };
      try { img.crossOrigin = 'anonymous'; } catch(e){}
      img.src = src;
    } catch(err) { cb(err); }
  }

  /* finalize: mostra preview, genera codice, salva su localStorage, crea link */
  function finalizeWithDataURL(dataURL){
    try {
      preview.src = dataURL; show(preview);
      show(resultArea);
      var code = genCode(CODE_LEN);
      codeText.innerText = code;
      try { localStorage.setItem('smi_' + code, dataURL); logMsg('Saved to localStorage: smi_' + code); } catch(e){ logMsg('localStorage error: ' + (e.message || e)); }
      links.innerHTML = '';
      var a = document.createElement('a');
      a.href = dataURL;
      a.className = 'btnlink';
      a.appendChild(document.createTextNode('Apri / Salva immagine'));
      a.setAttribute('download', 'sharemiishot.jpg');
      links.appendChild(a);

      dataOut.value = dataURL;
      show(dataArea);
      logMsg('Immagine processata. Codice: ' + code);
      setStatus('Immagine pronta (codice: ' + code + ').');
    } catch(e){ logMsg('finalize error: ' + (e.message || e)); setStatus('Errore finale'); }
  }

  /* single attempt to find and process */
  function attemptGrabOnce(){
    try {
      setStatus('Ricerca DOM per immagini...');
      var candidate = findCandidateImage();
      if(candidate){
        setStatus('Trovata immagine: ' + candidate);
        logMsg('Candidate src: ' + candidate);
        processImageSrc(candidate, function(err, dataURL){
          if(err){
            logMsg('processImageSrc error: ' + (err.message || err));
            setStatus('Errore processing: ' + (err.message || err));
          } else {
            finalizeWithDataURL(dataURL);
          }
        });
        return true;
      }
      return false;
    } catch(e){
      logMsg('attemptGrabOnce exception: ' + (e.message || e));
      return false;
    }
  }

  /* polling loop */
  function startPolling(){
    if(poller) return;
    pollStart = (new Date()).getTime();
    setStatus('Avvio ricerca immagine (polling)...');
    poller = setInterval(function(){
      try {
        var found = attemptGrabOnce();
        if(found){
          clearInterval(poller); poller = null;
          setStatus('Immagine trovata e processata.');
          return;
        }
        var now = (new Date()).getTime();
        if(now - pollStart > POLL_TIMEOUT){
          clearInterval(poller); poller = null;
          setStatus('Timeout: immagine non trovata entro ' + (POLL_TIMEOUT/1000) + 's.');
          logMsg('Polling timeout');
        } else {
          setStatus('Ricerca in corso... (' + Math.round((now - pollStart)/1000) + 's)');
        }
      } catch(e){
        clearInterval(poller); poller = null;
        logMsg('Polling exception: ' + (e.message || e));
        setStatus('Errore durante polling');
      }
    }, POLL_INTERVAL);
  }

  function stopPolling(){
    if(poller){ clearInterval(poller); poller = null; setStatus('Ricerca fermata dall\'utente.'); logMsg('Polling stopped by user'); }
    else { setStatus('Nessuna ricerca attiva'); }
  }

  /* handlers */
  grabBtn.addEventListener('click', function(){
    try {
      preview.src = '';
      hide(preview);
      hide(resultArea);
      qrHolder.innerHTML = '';
      links.innerHTML = '';
      dataOut.value = '';
      hide(dataArea);
      startPolling();
    } catch(e){ logMsg('grabBtn click error: ' + (e.message || e)); }
  }, false);

  stopBtn.addEventListener('click', function(){ stopPolling(); }, false);

  /* expose helper to console for debugging (optional) */
  try { window.__sharemiishot_attempt = attemptGrabOnce; } catch(e){}

  /* initial log */
  logMsg('sharemiishot avviato. User-Agent: ' + (navigator.userAgent || 'unknown'));
  setStatus('Pronto. Premi "Prendi immagine dal sistema" dopo HOME->Browser.');

})();
</script>
</body>
</html>
