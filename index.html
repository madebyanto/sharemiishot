<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ShareMiiShot — Wi-Fi Upload</title>
<style>
body{font-family:Arial,sans-serif;max-width:900px;margin:16px auto;padding:12px;color:#111;background:#fff}
header{display:block;margin-bottom:10px}
h1{font-size:1.05rem;margin:8px 0}
.box{border:1px dashed #bbb;padding:12px;border-radius:8px;margin:12px 0;background:#fafafa}
button{padding:10px 14px;font-size:1rem;border-radius:6px;border:0;background:#0b84ff;color:#fff;cursor:pointer}
button[disabled]{opacity:0.55;cursor:not-allowed}
#preview{display:block;margin-top:8px;max-width:100%;border:1px solid #ccc;padding:4px;border-radius:4px}
#logBox{border:1px solid #ccc;padding:8px;height:160px;overflow:auto;font-family:monospace;background:#f8f8f8;border-radius:6px;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <h1>ShareMiiShot — Wi-Fi Upload (Wii U)</h1>
</header>

<div class="box">
  <label>Seleziona immagine: <input id="fileInput" type="file" accept="image/jpeg,image/png" /></label>
  <div style="margin-top:8px">
    <button id="uploadBtn" disabled>Invia al server Wi-Fi</button>
  </div>
  <div id="status" style="margin-top:8px">Stato: pronto</div>
  <img id="preview" alt="Anteprima immagine" class="hidden"/>
</div>

<div class="box">
  <div><strong>Log diagnostico:</strong></div>
  <div id="logBox"></div>
</div>

<script>
// Helpers
function get(id){ return document.getElementById(id); }
function log(msg){ try { var lb = get('logBox'); lb.textContent += '['+(new Date()).toLocaleTimeString()+'] '+msg+'\n'; lb.scrollTop = lb.scrollHeight; } catch(e){} }
function setStatus(text){ try { get('status').innerText = 'Stato: ' + text; } catch(e){} log(text); }
function show(elem){ elem.style.display='block'; }
function hide(elem){ elem.style.display='none'; }

// State
var currentFile = null;
var preview = get('preview');
var uploadBtn = get('uploadBtn');
var fileInput = get('fileInput');

// Config
var SERVER_IP = '192.168.x.x'; // Cambia con IP del PC che esegue il server Python
var SERVER_PORT = 8080;

// File selection
fileInput.addEventListener('change', function(){
  var f = fileInput.files && fileInput.files[0];
  if(!f){ setStatus('Nessun file selezionato'); uploadBtn.disabled = true; return; }
  currentFile = f;
  setStatus('File selezionato: ' + f.name + ' ('+Math.round(f.size/1024)+' KB)');
  // Anteprima
  try {
    var reader = new FileReader();
    reader.onload = function(e){
      preview.src = e.target.result;
      show(preview);
      uploadBtn.disabled = false;
    };
    reader.onerror = function(){ setStatus('Errore lettura file'); };
    reader.readAsDataURL(f);
  } catch(e){ setStatus('Errore FileReader: '+(e.message||e)); }
});

// Upload function
uploadBtn.addEventListener('click', function(){
  if(!currentFile){ setStatus('Nessun file da inviare'); return; }

  try {
    var xhr = new XMLHttpRequest();
    var url = 'http://' + SERVER_IP + ':' + SERVER_PORT + '/';
    xhr.open('POST', url, true);

    var boundary = '----WebKitFormBoundary' + Math.random().toString(36).substr(2);
    xhr.setRequestHeader('Content-Type', 'multipart/form-data; boundary=' + boundary);

    xhr.onload = function(){
      if(xhr.status === 200){
        setStatus('Upload completato con successo!');
        log('Server risponde: ' + xhr.responseText);
      } else {
        setStatus('Upload fallito: ' + xhr.status);
        log('Errore server: ' + xhr.responseText);
      }
    };
    xhr.onerror = function(){ setStatus('Errore invio HTTP'); log('XHR error'); };

    // costruisci multipart body
    var body = '--'+boundary+'\r\n';
    body += 'Content-Disposition: form-data; name="file"; filename="'+currentFile.name+'"\r\n';
    body += 'Content-Type: '+currentFile.type+'\r\n\r\n';

    var reader = new FileReader();
    reader.onload = function(e){
      var binary = e.target.result;
      // Convert base64 string to binary string
      var raw = atob(binary.split(',')[1]);
      body += raw;
      body += '\r\n--'+boundary+'--\r\n';

      // Send as ArrayBuffer
      var buf = new Uint8Array(body.length);
      for(var i=0;i<body.length;i++){ buf[i]=body.charCodeAt(i); }
      xhr.send(buf.buffer);
      setStatus('Upload in corso...');
    };
    reader.readAsDataURL(currentFile);

  } catch(e){ setStatus('Errore upload: '+(e.message||e)); log('Upload exception: '+(e.message||e)); }
});
</script>

</body>
</html>
